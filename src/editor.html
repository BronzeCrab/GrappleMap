<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>GrappleMap Editor</title>
		<style>
			body {
				margin:0px;
				padding:0px;
				height:100%
			}

			.emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
			/* the canvas *must not* have any border or padding, or mouse coords will be wrong */

			canvas.emscripten {
				border: 0px none;
				margin: 0px;
				background-color: black;
				width:100%;
				height:100%;
			}

			#emscripten_logo {
				display: inline-block;
				margin: 0;
			}

      .spinner {
        height: 30px;
        width: 30px;
        margin: 0;
        margin-top: 20px;
        margin-left: 20px;
        display: inline-block;
        vertical-align: top;

        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;

        border-left: 5px solid rgb(235, 235, 235);
        border-right: 5px solid rgb(235, 235, 235);
        border-bottom: 5px solid rgb(235, 235, 235);
        border-top: 5px solid rgb(120, 120, 120);
        
        border-radius: 100%;
        background-color: rgb(189, 215, 46);
      }

      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }

      #status {
        display: inline-block;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 20px;
        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      #progress {
        height: 20px;
        width: 30px;
      }

      #controls {
        display: inline-block;
        float: right;
        vertical-align: top;
        margin-top: 30px;
        margin-right: 20px;
      }

      #output {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        margin-top: 10px;
        border-left: 0px;
        border-right: 0px;
        padding-left: 0px;
        padding-right: 0px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
      }

		.button {
		  border-color:#e0e0e0;
		  border-radius:3px;
		  border-style:solid;
		  border-width:1px 1px 2px;
		  color:#303030;
		  font-family: monospace;
		  font-size: .9em;
		  padding:1px 6px;
		  white-space:nowrap
		  }

		table.controlhelp td:first-child {
			text-align: right;
		}

		a.segment_indicator {
			color: white;
		}

		a.position_indicator {
			color: white;
		}

		table.controlhelp td:nth-child(2) {
			padding-left: 1em;
			padding-right: 1em;
			text-align: right;
		}

		table.mode_table {
			width: 100%;
			border-spacing: 0;
		}

		table.mode_table tr {
			padding: 0px;
			margin: 0px;
		}

		table.mode_table td {
			padding: 10px;
			margin: 0px;
		}

		#bigtable {
			position: absolute;
			bottom: 0;
			top: 0;
			left: 0;
			right: 0;
		}

		#selection_box {
			padding: 1em;
			 padding-left: 1.5em;
		}

		div.seq_desc {
			/* border: 1px solid black; */
			margin: 1em;
			margin-left: 1em;
			padding: 0.5em;
			background: white;
			color: black;

		}

		</style>
	</head>
	<body>


<!--    <div class="emscripten" id="status">Downloading...</div>-->
<!--
<span id='controls'>
  <span><input type="checkbox" id="resize">Resize canvas</span>
  <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
  <span><input type="button" value="Fullscreen" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked, 
                                                                            document.getElementById('resize').checked)">
  </span>
</span>
	-->
<!--
		<div class="emscripten">
			<progress value="0" max="100" id="progress" hidden=1></progress>
		</div>
-->

		<div style='position:absolute;top:0;left:0;width:75%;padding:0px;border:0px none;margin:0px;background:black'>
		<!--			<div class="spinner" id='spinner'></div> -->
			<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()">
			</canvas>
		</div>

		<div style='position:absolute;top:0;left:75%;width:25%px;padding-left:40px;padding-right:40px;margin:0px;height:100%;overflow:auto'>
					<span style='text-align:center'>
						<h1>GrappleMap</h1>
						<h2>Editor</h2>
					</span>

					<table id='browse_controls' class='mode_table'>
						<tr>
							<td style='width:33%;text-align:center;background:skyblue'>
								<b>Browse</b>
							</td>
							<td style='width:33%;text-align:center;background:palegreen'>
								<button onclick='mode_change("playback")'>Playback</button>
							</td>
							<td style='width:33%;text-align:center;background:lightcoral'>
								<button onclick='mode_change("edit")'>Edit</button>
							</td>
						</tr>
						<tr>
							<td colspan='3' style='background:skyblue'>
								<ul>
									<li><button onclick='browseto()'>Go to</button></li>
									<li><input type='checkbox' checked onchange='gui_command("confine " + this.checked)'> Confine to path</li>
									<li><button onclick='gui_command("mirror_view")'>Mirror view</button></li>
									<li>Load database: <input type='file' id='fileinput' onchange='loadDB(this.files[0])'></li>
								</ul>
							</td>
						</tr>
					</table>

					<table id='playback_controls' class='mode_table' style='display:none'>
						<tr>
							<td style='width:33%;text-align:center;background:skyblue'>
								<button onclick='mode_change("browse")'>Browse</button>
							</td>
							<td style='width:33%;text-align:center;background:palegreen'>
								<b>Playback</b>
							</td>
							<td style='width:33%;text-align:center;background:lightcoral'>
								<button onclick='mode_change("edit")'>Edit</button>
							</td>
						</tr>
						<tr>
							<td colspan='3' style='background:palegreen'>
								&nbsp;
							</td>
						</tr>
					</table>

					<table id='edit_controls' class='mode_table' style='display:none'>
						<tr>
							<td style='width:33%;text-align:center;background:skyblue'>
								<button onclick='mode_change("browse")'>Browse</button>
							</td>
							<td style='width:33%;text-align:center;background:palegreen'>
								<button onclick='mode_change("playback")'>Playback</button>
							</td>
							<td style='width:33%;text-align:center;background:lightcoral'>
								<b>Edit</b>
							</td>
						</tr>
						<tr>
							<td colspan='3' style='background:lightcoral'>
								<table>
									<tr>
										<td style='vertical-align:top'>
											<p>
												Frame:
												<ul>
													<li><button onclick='gui_command("insert_keyframe")'>Insert</button></li>
													<li><button onclick='gui_command("delete_keyframe")'>Delete</button></li>
													<li><button onclick='gui_command("swap_players")'>Swap players</button></li>
												</ul>
											</p>
										</td>
										<td>
											<p>
												Manipulate:<br>
												<input name='joints_to_edit' type='radio' checked
													onclick='gui_command("joints_to_edit single_joint")'> single joint<br>
												<input name='joints_to_edit' type='radio'
													onclick='gui_command("joints_to_edit whole_player")'> whole player<br>
												<input name='joints_to_edit' type='radio'
													onclick='gui_command("joints_to_edit both_players")'> both players
											</p>
											<p>
												Confine to:<br>
												<input type='checkbox'
													onchange='gui_command("confine_horizontal " + this.checked)'> horizontal edits<br>
												<input type='checkbox'
													onchange='gui_command("confine_interpolation " + this.checked)'> linear interpolations
											</p>
										</td>
									</tr>
								</table>
								Metadata:
								<textarea id='metadata' rows='6' style='width:100%'>
								</textarea>
							</td>
						</tr>
					</table>

					<div id='selection_box' style='background:gold;padding-top:1em;padding-right:20px;margin-top:1em;text-align:center'>
						<b>Path</b><br><br>

						<div id='selection_body' style='padding-right:1em;text-align:left'>
						</div>

						<hr>

						<table style='with:100%'>
							<tr>
								<td style='width:50%'>
									Prepend:<br>
									<div id='pre_selection'></div>
								</td>
								<td style='width:50%;background:red'>
									Append:<br>
									<div id='post_selection'></div>
								</td>
							</tr>
						</table>
					</div>


					<!--
					<p><b>Mouse controls:</b></p>
					<table class='controlhelp' style='margin:0px'>
						<tr><td>Right click + drag joint</td><td>-</td><td>Browse through current transition</td></tr>
						<tr><td>Left click + drag joint</td><td>-</td><td>Update joint position in keyframe (edit mode only)</td></tr>
						<tr><td>Middle click + drag anywhere</td><td>-</td><td>Rotate camera</td></tr>
					</table>
					-->
					<textarea id="output" rows="4" style='width:100%;display:none'></textarea>
		</div>

		<script type='text/javascript'>

      //var statusElement = document.getElementById('status');
      //var progressElement = document.getElementById('progress');
      //var spinnerElement = document.getElementById('spinner');

      var Module = {
        preRun: [],
        postRun: [],
        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            console.log(text);
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          if (0) { // XXX disabled for safety typeof dump == 'function') {
            dump(text + '\n'); // fast, straight to the real console
          } else {
            console.error(text);
          }
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
        /*
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          //statusElement.innerHTML = text;
          */
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          //Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        //Module.setStatus('Exception thrown, see JavaScript console');
        //spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

          (function() {
            var memoryInitializer = 'grapplemap_editor.js.mem';
            if (typeof Module['locateFile'] === 'function') {
              memoryInitializer = Module['locateFile'](memoryInitializer);
            } else if (Module['memoryInitializerPrefixURL']) {
              memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
            }
            var meminitXHR = Module['memoryInitializerRequest'] = new XMLHttpRequest();
            meminitXHR.open('GET', memoryInitializer, true);
            meminitXHR.responseType = 'arraybuffer';
            meminitXHR.send(null);
          })();

          var script = document.createElement('script');
          script.src = "grapplemap_editor.js";
          document.body.appendChild(script);


	var slider = document.getElementById("slider");
	var browse_controls = document.getElementById('browse_controls');
	var playback_controls = document.getElementById('playback_controls');
	var edit_controls = document.getElementById('edit_controls');
	var selection_body = document.getElementById('selection_body');
	var the_selection;

	function loadDB(f)
	{
		var reader = new FileReader();

		reader.onload = function(e)
			{
				console.log("ok got " + e.target.result.length);
				Module.loadDB(e.target.result);
			};

		reader.readAsArrayBuffer(f);
	}

	function gui_command(cmd)
	{
		Module.gui_command(cmd);
	}

	function mode_change(mode)
	{
		browse_controls.style.display = (mode == 'browse' ? 'table' : 'none');
		playback_controls.style.display = (mode == 'playback' ? 'table' : 'none');
		edit_controls.style.display = (mode == 'edit' ? 'table' : 'none');

		gui_command('mode ' + mode);
	}

	function sync_resolution()
	{
		gui_command("resolution " + canvas.clientWidth + " " + canvas.clientHeight);
		setTimeout(sync_resolution, 1000);
	}

	setTimeout(sync_resolution, 1000);

	function gui_commander(cmd)
	{
		return function(){ gui_command(cmd); };
	}

	function browseto()
	{
		var desc = prompt(
			"Specify one of:\n" +
			"- a position (e.g. 'p34')\n" +
			"- a transition (e.g. 't1383')\n" +
			"- a path (e.g. '39,23,45')");

		if (desc == null) return;

		gui_command("browseto " + desc);
	}

	function highlight_segment(seq, seg, pos)
	{
		the_selection.forEach(function(selseq)
			{
				if (selseq.id == seq)
					document.getElementById('metadata').value
						= selseq.description.join("\n");

				selseq.segment_indicators.forEach(function(indicator, selseg)
					{
						indicator.style.color =
							(selseq.id == seq && seg == selseg && pos == -1
								? 'lime'
								: 'white');
					});

				selseq.position_indicators.forEach(function(indicator, p)
					{
						indicator.style.color =
							(selseq.id == seq && pos == p
								? 'lime'
								: 'white');
					});
			});
	}

	function set_selection(sel, post_choices, pre_choices)
	{
		selection_body.innerHTML = '';

		for (var i = 0; i != sel.length; ++i)
		{
			var seq = sel[i];
			var desc = seq.description;

			selection_body.appendChild(document.createTextNode(desc[0] + " "));
			// + " (t" + seq.id + ": " + desc[0] + " "));

			if (i == 0 || i == sel.length - 1) // add remove button
			{
				var btn = document.createElement("button");
				btn.appendChild(document.createTextNode("x"));
				btn.onclick = gui_commander("set_selected " + seq.id);
				selection_body.appendChild(btn);
			}

			selection_body.appendChild(document.createElement("br"));

			seq.segment_indicators = [];
			seq.position_indicators = [];

			function add_pos_indicator(posnum)
			{
				var t = document.createElement("a");
				t.className = "position_indicator";
				t.text = "●";
				t.onmouseover = (function(x, y)
					{
						return function()
							{
								gui_command("goto_position " + x + " " + y);
								highlight_segment(x, y, y);
							};
					})(seq.id, posnum);
				seq.position_indicators.push(t);
				selection_body.appendChild(t);
			}

			for (var segnum = 0; segnum != seq.frames.length - 1; ++segnum)
			{
				add_pos_indicator(segnum);
// ▬⬤
				var t = document.createElement("a");
				t.className = "segment_indicator";
				t.text = "➔"; // "▪"; //  "▬"; // "█";
				t.onmouseover = (function(x, y)
					{
						return function()
							{
								gui_command("goto_segment " + x + " " + y);
								highlight_segment(x, y, -1);
							};
					})(seq.id, segnum);

				seq.segment_indicators.push(t);
				selection_body.appendChild(t);
			}

			add_pos_indicator(seq.frames.length - 1);

			selection_body.appendChild(document.createElement("br"));
/*
			var descdiv = document.createElement("div");
			descdiv.className = "seq_desc";

			var first = true;

			for (var j = 1; j <= desc.length - 1; ++j)
			{
				if (!first) descdiv.appendChild(document.createElement("br"));
				else first = false;
			//	descdiv.appendChild(document.createTextNode(desc[j]));
			}
*/
			//selection_body.appendChild(descdiv);
		}

		{
			var post_div = document.getElementById('post_selection');
			post_div.innerHTML = "";

			post_choices.forEach(function(c)
				{
					var btn = document.createElement("button");
					btn.appendChild(document.createTextNode(c[1][0]));
					btn.addEventListener("click", (function(sn)
						{ return function(){ gui_command("set_selected " + sn + " true"); }; })(c[0]));
					post_div.appendChild(btn);
					post_div.appendChild(document.createElement("br"));
				});
		}

		{
			var pre_div = document.getElementById('pre_selection');
			pre_div.innerHTML = "";

			pre_choices.forEach(function(c)
				{
					var btn = document.createElement("button");
					btn.appendChild(document.createTextNode(c[1][0]));
					btn.addEventListener("click", (function(sn)
						{ return function(){ gui_command("set_selected " + sn + " true"); }; })(c[0]));
					pre_div.appendChild(btn);
					pre_div.appendChild(document.createElement("br"));
				});
		}

		the_selection = sel;
	}

	function v3(x,y,z) { return 0; }

/*
	var myblob = new Blob(["dinghmz"], {type:"text/plain"});

	var fileURL = URL.createObjectURL(myblob);
    var a         = document.createElement('a');
	a.href        = fileURL; 
	a.text        = "Download DB";
	document.body.appendChild(a);
*/

		</script>
	</body>
</html>
